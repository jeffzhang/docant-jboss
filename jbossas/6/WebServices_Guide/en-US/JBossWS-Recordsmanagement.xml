<?xml version="1.0" encoding="UTF-8"?><chapter id="chap_JBossWS-Recordsmanagement"><title>JBossWS-Recordsmanagement</title><para>JBossWS records' collection and management system gives administrators a means of performing custom analysis of their webservice traffic as well as exporting communication logs.</para><para/><para> </para><section id="JBossWS-Recordsmanagement_What_is_recorded"><title>What is recorded</title><para>Each record is basically composed of a message plus additional information; here are the current record attributes:</para><itemizedlist><listitem><para> Creation date </para></listitem><listitem><para> Source host </para></listitem><listitem><para> Destination host </para></listitem><listitem><para> Message type (in/out) </para></listitem><listitem><para> Invoked endpoint operation </para></listitem><listitem><para> Message envelope (including both soap:header and soap:body for SOAP messages) </para></listitem><listitem><para> Http headers </para></listitem><listitem><para> Record group ID (allowing records belonging to the same message flow to be linked together) </para></listitem></itemizedlist><para>Of course records may also have meaningful values for a subset of the afore mentioned record attributes.</para><para> </para></section>
<section id="JBossWS-Recordsmanagement_Use_cases"><title>Use cases</title><para>What are records useful for? In spite of <link linkend="chap_JBossWS-Endpointmanagement">endpoint metrics</link> that provide response time information and counts of invocations, records provide users with rich data about the content of the exchanged messages and their sender/receiver. The record system allows fine grained management and is customizable according to the users need; some of the use cases supported by the default configuration are:</para><itemizedlist><listitem><para> Logging request and response messages: being able to record messages received from and sent to a given service consumer without stopping the provider may be really useful. You just need to set the <emphasis>recording</emphasis> attribute of their endpoint's LogRecorder to true. The added value of this logging solution comes from the use of filters through which messages coming from a given address and related to a given wsdl operation only can be logged. </para></listitem><listitem><para> Accountability: service providers may want to know which consumers are actually hitting a given service. This can be done for example using the <emphasis>getClientHosts</emphasis> functionality of the MemoryBufferRecorder once it has been switched to recording state. </para></listitem><listitem><para> Getting statistics, filtering records: service administrators might want to see the last records related to a given endpoint or operation, the last records related to messages coming from a given customer and the response the system gave them, etc. These information can be obtained using the <emphasis>getRecordsByOperation</emphasis>, <emphasis>getRecordsByClientHost</emphasis> or the more general <emphasis>getMatchingRecords</emphasis> functionality of the MemoryBufferRecorder.</para></listitem></itemizedlist><para> </para></section>
<section id="JBossWS-Recordsmanagement_How_it_works_and_how_to_use_it"><title>How it works and how to use it</title><para>The recording system is composed of</para><itemizedlist><listitem><para> JAX-WS handlers intercepting inbound and outbound communication </para></listitem><listitem><para> Record processors plugged into deployed endpoints; handlers collect records and send them to every processors through the current endpoint. Processors may store records, convert them, log them, ... </para></listitem><listitem><para> MBean views of processors that can be used to configure and fine tune recording at runtime </para></listitem><listitem><para> Record filters allowing selection of information to be recorded as well as providing means of performing custom queries on the saved records.</para></listitem></itemizedlist><para> </para><section id="JBossWS-Recordsmanagement_Server_side"><title>Server side</title><para>On server side records are collected by JAX-WS handlers and passed to the configured processors. JBossWS comes with two default record processors that are plugged into every endpoint during the deployment:</para><itemizedlist><listitem><para> LogRecorder: a simple record processor that writes records to the configured log. </para></listitem><listitem><para> MemoryBufferRecorder: a record processor that keeps the last received records in memory and allows user to search / get statistics on them. </para></listitem></itemizedlist><para>Every processors can be fine tuned to process some record attributes only according to the user and/or performance requirements. Default processors are not in recording mode upon creation, thus you need to switch them to recording mode through their MBean interfaces (see the <emphasis>Recording</emphasis> flag in the jmx-console).</para><para>Common processor properties and their respective defaults values are:</para><itemizedlist><listitem><para> processDestinationHost (true) </para></listitem><listitem><para> processSourceHost (true) </para></listitem><listitem><para> processHeaders (true) </para></listitem><listitem><para> processEnvelope (true) </para></listitem><listitem><para> processMessageType (true) </para></listitem><listitem><para> processOperation (true) </para></listitem><listitem><para> processDate (true) </para></listitem><listitem><para> recording (false) </para></listitem></itemizedlist><para>The recorders can be configured in the stacks bean configuration</para><screen xml:space="preserve">  &lt;!-- Installed Record Processors--&gt;
  &lt;bean name="WSMemoryBufferRecorder" class="org.jboss.wsf.framework.management.recording.MemoryBufferRecorder"&gt;
    &lt;property name="recording"&gt;false&lt;/property&gt;
  &lt;/bean&gt;
  &lt;bean name="WSLogRecorder" class="org.jboss.wsf.framework.management.recording.LogRecorder"&gt;
    &lt;property name="recording"&gt;false&lt;/property&gt;
  &lt;/bean&gt;
</screen><para>The recording system is available for all the JBossWS supported stacks. However slightly different procedure is required to enable it depending on the used stack.</para><variablelist><varlistentry><term><emphasis role="bold">Native stack</emphasis> </term><listitem/></varlistentry></variablelist><para>Native stack comes with <ulink url="http://community.jboss.org/docs/DOC-13512">JBossWS - JAX-WS Endpoint Configuration</ulink>. The default standard endpoint already has the server side recording handler:</para><screen xml:space="preserve">  &lt;endpoint-config&gt;
    &lt;config-name&gt;Standard Endpoint&lt;/config-name&gt;
    &lt;pre-handler-chains&gt;
      &lt;javaee:handler-chain&gt;
        &lt;javaee:protocol-bindings&gt;##SOAP11_HTTP&lt;/javaee:protocol-bindings&gt;
        &lt;javaee:handler&gt;
          &lt;javaee:handler-name&gt;Recording Handler&lt;/javaee:handler-name&gt;
          &lt;javaee:handler-class&gt;org.jboss.wsf.framework.invocation.RecordingServerHandler&lt;/javaee:handler-class&gt;
        &lt;/javaee:handler&gt;
      &lt;/javaee:handler-chain&gt;
    &lt;/pre-handler-chains&gt;
  &lt;/endpoint-config&gt;
</screen><para>thus nothing is required to use it since it is automatically installed in the pre-handler-chain. Of course you might want to add it to other endpoint configurations you're using.</para><variablelist><varlistentry><term><emphasis role="bold">Metro and CXF stacks </emphasis></term><listitem/></varlistentry></variablelist><para>Other stacks require users to manually add the <emphasis>org.jboss.wsf.framework.invocation.RecordingServerHandler</emphasis> to their endpoint handler chain. This can be done <link linkend="chap_JBossWS-UserGuide">the same way common user handlers are added</link>.</para><para>Once the handler is properly added to the chain, log recording configuration is agnostic to the used stack. Users just need to tune the processors parameters though their MBean interfaces.</para><para> </para></section>
<section id="JBossWS-Recordsmanagement_Client_side"><title>Client side</title><para>JMX management of processors is of course available on server side only. However users might also be interested in collecting and processing records on client side. Since handlers can be set on client side too, customer handlers could be configured to capture messages almost like the <emphasis>RecordingServerHandler</emphasis> does. This is left to the users since it is directly linked to their custom needs. For instance a common use could be to pass client side collected records to the LogRecorder.</para><para> </para></section>
</section>
<section id="JBossWS-Recordsmanagement_Advanced_hints"><title>Advanced hints</title><section id="JBossWS-Recordsmanagement_Adding_custom_recorders"><title>Adding custom recorders</title><para>As previously said, the recording system is extensible: JBossWS users can write their own processors and plug them at runtime into their deployed endpoints through the <emphasis>addRecordProcessor</emphasis> functionality of the ManagedEndpoint MBean. Every processor needs to implement the <emphasis>org.jboss.wsf.spi.management.recording.RecordProcessor</emphasis> interface. Then you can choose one of the two following options:</para><itemizedlist><listitem><para> Give you record processor an MBean interface declaring the manageable attributes: the recording system will plug your processor to the endpoint and register a management MBean for it using your interface. This allows you to create highly configurable custom processors. For an example of this development option, take a look at the <emphasis>org.jboss.wsf.framework.management.recording.MemoryBufferRecorder</emphasis>. </para></listitem><listitem><para> Add your record processor to the managed endpoint as is: the recording system will plug it to the endpoint and register a standard management MBean for its basic processing configuration. The <emphasis>org.jboss.wsf.framework.management.recording.LogRecorder</emphasis> is an example of this development option. </para></listitem></itemizedlist><para>A code snippet showing how to get the MBeanProxy instance which you can invoke MBean with can be found <link linkend="chap_JBossWS-Endpointmanagement">here</link>.</para></section>
<section id="JBossWS-Recordsmanagement_Handlers_position"><title>Handler's position</title><para>Of course the recording handler's position in the handler chain influences the collected records. As a matter of fact some information may or may not be available at a given point of the handler chain execution. The standard endpoint configuration declares the RecordingServerHandler into the pre-handler-chain. Speaking of the native stack, this means for example that you'll get the invoked operation data and that decrypted messages will be recorded if using WS-Security, since the WS-Security handler runs in the post-handler-chain. Users might want to change the recording handler's position in the chain according to their requirements.</para></section>
<section id="JBossWS-Recordsmanagement_Multiple_handlers"><title>Multiple handlers</title><para>Records attributes include a record group ID that is meant to link records whose messages belong to the same message flow (a request-response for example). In order to set the right group ID to the records, the current ID is associated to the thread that is processing the endpoint invocation. This means that multiple related records can be linked together and extracted together from a processor.</para><para>For this reason, you might want to install multiple recording handlers into different points of the handler chain. For instance, it could make sense to record messages both before and after encryption/decryption when using WS-Security.</para></section>
</section>
<section id="JBossWS-Recordsmanagement_Future_extensions"><title>Future extensions</title><para>This paragraph covers eventual future extensions and/or idea JBossWS users may want to leverage for their own business.</para><section id="JBossWS-Recordsmanagement_Database_recorder"><title>Database recorder</title><para>The MemoryBufferRecorder provides interesting functionalities to query the collected records set. For obvious reasons, records are discarded once a given size of the buffer is reached.</para><para>A DB based recorder could be developed; it should work the same way the MemoryBufferRecorder does, except for records that should be saved through a given datasource. This will provide persistence of data even in case of application server reboot and webservice application redeploy. It will also allow records coming from different node of a cluster to be stored together. Finally this would allow administrators to directly query the database, which might be far more efficient.</para></section>
<section id="JBossWS-Recordsmanagement_Custom_log_writer"><title>Custom log writer</title><para>The idea of getting statistics from collected records could be further exploited getting custom logs from the records. These logs could be outputted by a custom processor in standard or proprietary formats allowing them to be imported into eventual third-party log processing tools which might offer complex/funky graphic or statistic functionalities and so on.</para></section>
</section>
<section id="JBossWS-Recordsmanagement_References"><title>References</title><para>You might want to take a look at the <emphasis>org.jboss.wsf.framework.management.recording</emphasis> and <emphasis>org.jboss.wsf.spi.management.recording</emphasis> packages in the source code to better understand how all this works and can be used.</para></section>
</chapter>