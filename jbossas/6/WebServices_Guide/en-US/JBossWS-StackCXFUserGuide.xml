<?xml version="1.0" encoding="UTF-8"?><chapter id="chap_JBossWS-StackCXFUserGuide"><title>JBossWS-StackCXFUserGuide</title><note><para><para>This page covers features available in <emphasis role="bold">JBossWS CXF stack only</emphasis>. <link linkend="chap_JBossWS-UserGuide">Please refer to the common user guide</link> for a basic introduction to JAX-WS programming as well as documentation on all features, tools, etc. the JBossWS Web Service Framework provides for every supported stack (including CXF stack).</para><para> </para> <para>Also please note this page does not go through the documentation of every feature, option, etc. provided by Apache CXF; on the countrary the only topics covered here are specific issues regarding integration with JBoss and stack specific features provided by JBossWS Web Service Framework for the CXF stack. A few tutorials are also provided for show how to leverage some WS technologies.</para> <para>The <emphasis>official Apache CXF documentation</emphasis> is available <ulink url="http://cxf.apache.org">here</ulink>.</para></para></note><para/><para> </para><section id="JBossWS-StackCXFUserGuide_JBossWS_CXF_Integration"><title>JBossWS CXF Integration</title><section id="JBossWS-StackCXFUserGuide_Creating_a_Bus_instance"><title>Creating a Bus instance</title><para>Most of the Apache CXF features are configurable using the <emphasis>org.apache.cxf.Bus</emphasis> class. New Bus instances are produced by the currently configured <emphasis>org.apache.cxf.BusFactory</emphasis> implementation the following way:</para><screen xml:space="preserve">Bus bus = BusFactory.newInstance().createBus();
</screen><para>The algorithm for selecting the actual implementation of BusFactory to be used leverages the Service API, basically looking for optional configurations in META-INF/services/... location using the current classloader. JBossWS-CXF integration comes with his own implementation of BusFactory, <emphasis>org.jboss.wsf.stack.cxf.client.configuration.JBossWSBusFactory</emphasis>, that allows for automatic detection of Spring availability as well as seamless setup of JBossWS customizations on top of Apache CXF. JBossWSBusFactory is <emphasis>automatically</emphasis> retrieved by the BusFactory.newInstance() call above.</para><para> </para><para>JBossWS users willing to explicitely use functionalities of <emphasis>org.apache.cxf.bus.spring.SpringBusFactory</emphasis> or <emphasis>org.apache.cxf.bus.CXFBusFactory,</emphasis> get the same API with JBossWS additions through JBossWSBusFactory:</para><screen xml:space="preserve">String myConfigFile = ...
Bus bus = <emphasis role="bold">new</emphasis> JBossWSBusFactory().createBus(myConfigFile);
</screen><para> </para><screen xml:space="preserve">Map&lt;Class, Object&gt; myExtensions = <emphasis role="bold">new</emphasis> HashMap&lt;Class, Object&gt;();
myExtensions.put(...);
Bus bus = <emphasis role="bold">new</emphasis> JBossWSBusFactory().createBus(myExtensions);
</screen></section>
<section id="JBossWS-StackCXFUserGuide_Server_Side_Integration_Customization"><title>Server Side Integration Customization</title><para>It is possible to customize the JBossWS and CXF integration by incorporating the CXF configuration file to the endpoint deployment archive. In order for that to be possible, JBossWS-CXF requires Spring to be installed in the application server. The Spring Framework libraries installation can be perfomed using the <ulink url="http://community.jboss.org/docs/DOC-13545">JBossWS-CXF installation</ulink>.</para><para>The convention is the following:</para><itemizedlist><listitem><para> file name must be <emphasis role="bold">jbossws-cxf.xml</emphasis> </para></listitem><listitem><para> for POJO deployments it is located in <emphasis role="bold">WEB-INF</emphasis> directory </para></listitem><listitem><para> for EJB3 deployments it is located in <emphasis role="bold">META-INF</emphasis> directory </para></listitem></itemizedlist><para>If user do not provide its own CXF configuration file, a default one is automatically generated during the deployment.</para><para>For POJO deployments the generated <emphasis role="bold">jbossws-cxf.xml</emphasis> has the following content:</para><screen xml:space="preserve">&lt;beans
  xmlns='<ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>'
  xmlns:xsi='<ulink url="http://www.w3.org/2001/XMLSchema-instance">http://www.w3.org/2001/XMLSchema-instance</ulink>'
  xmlns:beans='<ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>'
  xmlns:jaxws='<ulink url="http://cxf.apache.org/jaxws">http://cxf.apache.org/jaxws</ulink>'
  xsi:schemaLocation='<ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>
  <ulink url="http://www.springframework.org/schema/beans/spring-beans.xsd">http://www.springframework.org/schema/beans/spring-beans.xsd</ulink>
  <ulink url="http://cxf.apache.org/jaxws">http://cxf.apache.org/jaxws</ulink>
  <ulink url="http://cxf.apache.org/schemas/jaxws.xsd">http://cxf.apache.org/schemas/jaxws.xsd</ulink>'&gt;

  &lt;!-- one or more jaxws:endpoint POJO declarations --&gt;
  &lt;jaxws:endpoint
    id='POJOEndpoint'
    address='<ulink url="http://localhost:8080/pojo_endpoint_archive_name">http://localhost:8080/pojo_endpoint_archive_name</ulink>'  
    implementor='my.package.POJOEndpointImpl'&gt;
    &lt;jaxws:invoker&gt;
      &lt;bean class='org.jboss.wsf.stack.cxf.InvokerJSE'/&gt;
    &lt;/jaxws:invoker&gt;
  &lt;/jaxws:endpoint&gt;&lt;/beans&gt;
</screen><para>For EJB3 deployments the generated <emphasis role="bold">jbossws-cxf.xml</emphasis> has the following content:</para><screen xml:space="preserve">&lt;beans
  xmlns='<ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>'
  xmlns:xsi='<ulink url="http://www.w3.org/2001/XMLSchema-instance">http://www.w3.org/2001/XMLSchema-instance</ulink>'
  xmlns:beans='<ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>'
  xmlns:jaxws='<ulink url="http://cxf.apache.org/jaxws">http://cxf.apache.org/jaxws</ulink>'
  xsi:schemaLocation='<ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>
  <ulink url="http://www.springframework.org/schema/beans/spring-beans.xsd">http://www.springframework.org/schema/beans/spring-beans.xsd</ulink>
  <ulink url="http://cxf.apache.org/jaxws">http://cxf.apache.org/jaxws</ulink>
  <ulink url="http://cxf.apache.org/schemas/jaxws.xsd">http://cxf.apache.org/schemas/jaxws.xsd</ulink>'&gt;

  &lt;!-- one or more jaxws:endpoint EJB3 declarations --&gt;
  &lt;jaxws:endpoint
    id='EJB3Endpoint'
    address='<ulink url="http://localhost:8080/ejb3_endpoint_archive_name">http://localhost:8080/ejb3_endpoint_archive_name</ulink>'  
    implementor='my.package.EJB3EndpointImpl'&gt;
    &lt;jaxws:invoker&gt;
      &lt;bean class='org.jboss.wsf.stack.cxf.InvokerEJB3'/&gt;
    &lt;/jaxws:invoker&gt;
  &lt;/jaxws:endpoint&gt;&lt;/beans&gt;
</screen><para>Providing custom CXF configuration to the endpoint deployment is useful in cases when users want to use features that are not part of standard JAX-WS specification but CXF implements them. For example see <link linkend="chap_JBossWS-CXFWS-ReliableMessagingtutorial">CXF WS-RM tutorial</link> customization file. We are providing custom CXF endpoint configuration there to turn on WS-RM feature for endpoint.</para><note><para><para><emphasis><emphasis role="bold">Note</emphasis></emphasis></para><para><emphasis>When user incorporates its own CXF configuration to the endpoint archive he must reference either <emphasis role="bold">org.jboss.wsf.stack.cxf.InvokerJSE</emphasis> or <emphasis role="bold">org.jboss.wsf.stack.cxf.InvokerEJB3</emphasis> jaxws invoker bean there for each jaxws endpoint.</emphasis></para><para> </para></para></note></section>
</section>
<section id="JBossWS-StackCXFUserGuide_Extended_Features"><title>Extended Features</title><para><ulink url="http://cwiki.apache.org/CXF20DOC/ws-support.html">Here</ulink> is the CXF documentation about supported WS-* specifications.</para><para> </para><section id="JBossWS-StackCXFUserGuide_WSAddressing"><title>WS-Addressing</title><para>Apache CXF has a thorough support for WS-Addressing; details are available at the following pages:</para><para><ulink url="http://cwiki.apache.org/CXF20DOC/ws-addressing.html">CXF WS-Addressing documentation</ulink> <ulink url="http://cwiki.apache.org/CXF20DOC/wsaconfiguration.html">CXF WS-Addressing configuration</ulink></para><para> </para><para>Given the JAXWS specification currently covers WS-Addressing basic fuctionalities, users simply needing to enable it can make use of the @Addressing annotation and AddressingFeature, as shown in the following JBossWS-CXF tutorial:</para><para><link linkend="chap_JBossWS-CXFWS-Addressingtutorial">JBossWS-CXF WS-Addressing Tutorial</link></para><para> </para></section>
<section id="JBossWS-StackCXFUserGuide_WSReliableMessaging"><title>WS-ReliableMessaging</title><para>The Apache CXF technical documentation on WS-RealiableMessaging is available as a reference at the following pages:</para><para><ulink url="http://cwiki.apache.org/CXF20DOC/ws-reliablemessaging.html">CXF WS-ReliableMessaging documentation</ulink> <ulink url="http://cwiki.apache.org/CXF20DOC/wsrmconfiguration.html">CXF WS-ReliableMessaging configuration</ulink></para><para> </para><para>For a complete tutorial on how to enable WS-ReliableMessaging in a user client-server application, please take a look at:</para><para><link linkend="chap_JBossWS-CXFWS-ReliableMessagingtutorial">JBossWS-CXF WS-ReliableMessaging Tutorial</link></para><para> </para></section>
<section id="JBossWS-StackCXFUserGuide_WSPolicy"><title>WS-Policy</title><para>Apache CXF technical documentation on the WS-Policy engine and its configuration is available at:</para><para><ulink url="http://cwiki.apache.org/CXF20DOC/ws-policy.html">CXF WS-Policy documentation</ulink> <ulink url="http://cwiki.apache.org/CXF20DOC/wspconfiguration.html">CXF WS-Policy configuration</ulink></para><para> </para><para>For a complete sample of WS-Policy usage, please take a look at the JBossWS-CXF WS-ReliableMessaging tutorial below, as WS-RM is implemented leveraging policies there:</para><para><link linkend="chap_JBossWS-CXFWS-ReliableMessagingtutorial">JBossWS-CXF WS-Policy &amp; WS-ReliableMessaging Tutorial</link></para><para> </para><section id="JBossWS-StackCXFUserGuide_Note_on_PolicyEngine_setup"><title>Note on PolicyEngine setup</title><para>When building up the Bus without Spring libraries available on the classpath, JBossWSBusFactory still makes sure the PolicyEngine (as well as the RMManager) is properly setup. This allows users to leverage basic WS-Policy functionalities the same way they'd do with a full Spring-enabled Bus.</para><para> </para></section>
</section>
<section id="JBossWS-StackCXFUserGuide_WSSecurity"><title>WS-Security</title><para><ulink url="http://cxf.apache.org/">Apache CXF</ulink> leverages <ulink url="http://ws.apache.org/wss4j/">WSS4J</ulink> to provide WS-Security functionalities. This means that thanks to the JBossWS-CXF integration, users can create web service applications using CXF - WSS4J implementation of WS-Security and deploy them on JBoss Application Server.</para><para> </para><section id="JBossWS-StackCXFUserGuide_WSS4J_security_on_JBoss"><title>WSS4J security on JBoss</title><para>The Apache CXF documentation features an brief chapter on <ulink url="http://cwiki.apache.org/CXF20DOC/ws-security.html">how to use WSS4J security in CXF</ulink>. Here below instead you'll find some explanations on how to create a simple application and what you need to do to leverage WSS4J security on JBoss.</para><para> </para><variablelist><varlistentry><term><emphasis role="bold">Creating the web service endpoint </emphasis></term><listitem/></varlistentry></variablelist><para>First of all you need to create the web service endpoint / client using JAX-WS. This can be achieved in many ways, for instance you might want to:</para><orderedlist><listitem><para> write your endpoint implementation, then run the <emphasis role="bold"><emphasis>wsprovide</emphasis></emphasis> JBoss commandline tool which generates the service contract (bottom-up approach); </para></listitem><listitem><para> run the <emphasis role="bold"><emphasis>wsconsume</emphasis></emphasis> JBoss commandline tool to get the client artifacts from the service contract (top-down approach); </para></listitem><listitem><para> write your client implementation. </para></listitem></orderedlist><para> </para><variablelist><varlistentry><term><emphasis role="bold">Turn on WS-Security </emphasis></term><listitem/></varlistentry></variablelist><para>WSS4J security is triggered through interceptors that are added to the service and/or client. These interceptors allows you to perform the most common WS-Security related process:</para><itemizedlist><listitem><para> pass authentication tokens between services; </para></listitem><listitem><para> encrypt messages or parts of messages; </para></listitem><listitem><para> sign messages; </para></listitem><listitem><para> timestamp messages. </para></listitem></itemizedlist><para>Interceptors can be added either programmatically or through the Spring xml configuration of endpoints.</para><para>For instance, on server side, you can configure signature and encryption in the <emphasis>jboss-cxf.xml</emphasis> file this way:</para><screen xml:space="preserve">&lt;beans
  xmlns='<ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>'
  xmlns:xsi='<ulink url="http://www.w3.org/2001/XMLSchema-instance">http://www.w3.org/2001/XMLSchema-instance</ulink>'
  xmlns:beans='<ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>'
  xmlns:jaxws='<ulink url="http://cxf.apache.org/jaxws">http://cxf.apache.org/jaxws</ulink>'
  xsi:schemaLocation='<ulink url="http://cxf.apache.org/core">http://cxf.apache.org/core</ulink>
    <ulink url="http://cxf.apache.org/schemas/core.xsd">http://cxf.apache.org/schemas/core.xsd</ulink>
    <ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>
    <ulink url="http://www.springframework.org/schema/beans/spring-beans-2.0.xsd">http://www.springframework.org/schema/beans/spring-beans-2.0.xsd</ulink>
    <ulink url="http://cxf.apache.org/jaxws">http://cxf.apache.org/jaxws</ulink>
    <ulink url="http://cxf.apache.org/schemas/jaxws.xsd">http://cxf.apache.org/schemas/jaxws.xsd</ulink>'&gt;
  
  &lt;bean id="Sign_Request" class="org.apache.cxf.ws.security.wss4j.WSS4JInInterceptor"&gt;
    &lt;constructor-arg&gt;
      &lt;map&gt;
        &lt;entry key="action" value="Timestamp Signature Encrypt"/&gt;
        &lt;entry key="signaturePropFile" value="bob.properties"/&gt;
        &lt;entry key="decryptionPropFile" value="bob.properties"/&gt;
        &lt;entry key="passwordCallbackClass" value="org.jboss.test.ws.jaxws.samples.wsse.KeystorePasswordCallback"/&gt;
      &lt;/map&gt;
    &lt;/constructor-arg&gt;
  &lt;/bean&gt;
  
  &lt;bean id="Sign_Response" class="org.apache.cxf.ws.security.wss4j.WSS4JOutInterceptor"&gt;
    &lt;constructor-arg&gt;
      &lt;map&gt;
        &lt;entry key="action" value="Timestamp Signature Encrypt"/&gt;
        &lt;entry key="user" value="bob"/&gt;
        &lt;entry key="signaturePropFile" value="bob.properties"/&gt;
        &lt;entry key="encryptionPropFile" value="bob.properties"/&gt;
        &lt;entry key="encryptionUser" value="Alice"/&gt;
        &lt;entry key="signatureKeyIdentifier" value="DirectReference"/&gt;
        &lt;entry key="passwordCallbackClass" value="org.jboss.test.ws.jaxws.samples.wsse.KeystorePasswordCallback"/&gt;
        &lt;entry key="signatureParts" value="{Element}{<ulink url="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd">http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd</ulink>}Timestamp;{Element}{<ulink url="http://schemas.xmlsoap.org/soap/envelope/">http://schemas.xmlsoap.org/soap/envelope/</ulink>}Body"/&gt;
        &lt;entry key="encryptionParts" value="{Element}{<ulink url="http://www.w3.org/2000/09/xmldsig#">http://www.w3.org/2000/09/xmldsig#</ulink>}Signature;{Content}{<ulink url="http://schemas.xmlsoap.org/soap/envelope/">http://schemas.xmlsoap.org/soap/envelope/</ulink>}Body"/&gt;
        &lt;entry key="encryptionKeyTransportAlgorithm" value="<ulink url="http://www.w3.org/2001/04/xmlenc#rsa-1_5">http://www.w3.org/2001/04/xmlenc#rsa-1_5</ulink>"/&gt;
        &lt;entry key="encryptionSymAlgorithm" value="<ulink url="http://www.w3.org/2001/04/xmlenc#tripledes-cbc">http://www.w3.org/2001/04/xmlenc#tripledes-cbc</ulink>"/&gt;
      &lt;/map&gt;
    &lt;/constructor-arg&gt;
  &lt;/bean&gt;
  
  &lt;jaxws:endpoint
    id='ServiceImpl'
    address='<ulink url="http://@jboss.bind.address@:8080/jaxws-samples-wsse-sign-encrypt">http://@jboss.bind.address@:8080/jaxws-samples-wsse-sign-encrypt</ulink>'
    implementor='org.jboss.test.ws.jaxws.samples.wsse.ServiceImpl'&gt;
    &lt;jaxws:invoker&gt;
      &lt;bean class='org.jboss.wsf.stack.cxf.InvokerJSE'/&gt;
    &lt;/jaxws:invoker&gt;
    &lt;jaxws:outInterceptors&gt;
        &lt;bean class="org.apache.cxf.binding.soap.saaj.SAAJOutInterceptor"/&gt;
        &lt;ref bean="Sign_Response"/&gt;
    &lt;/jaxws:outInterceptors&gt;
    &lt;jaxws:inInterceptors&gt;
        &lt;ref bean="Sign_Request"/&gt;
        &lt;bean class="org.apache.cxf.binding.soap.saaj.SAAJInInterceptor"/&gt;
    &lt;/jaxws:inInterceptors&gt;
  &lt;/jaxws:endpoint&gt;
&lt;/beans&gt;
</screen><para>This specifies the whole security configuration (including algorithms and elements to be signed/encrypted); moreover it references a properties file (<emphasis>bob.properties</emphasis>) providing the keystore-related information:</para><screen xml:space="preserve">org.apache.ws.security.crypto.provider=org.apache.ws.security.components.crypto.Merlin
org.apache.ws.security.crypto.merlin.keystore.type=jks
org.apache.ws.security.crypto.merlin.keystore.password=password
org.apache.ws.security.crypto.merlin.keystore.alias=bob
org.apache.ws.security.crypto.merlin.file=bob.jks
</screen><para>As you can see in the <emphasis>jbossws-cxf.xml</emphasis> file above, a keystore password callback handler is also configured; while the properties file has the password for the keystore, this callback handler is used to set password for each key (it has to match the one used when each key was imported in the store). Here's a trivial example:</para><screen xml:space="preserve"><emphasis role="bold">package</emphasis> org.jboss.test.ws.jaxws.samples.wsse;
 
<emphasis role="bold">import</emphasis> java.io.IOException;
<emphasis role="bold">import</emphasis> java.util.HashMap;
<emphasis role="bold">import</emphasis> java.util.Map;
 
<emphasis role="bold">import</emphasis> javax.security.auth.callback.Callback;
<emphasis role="bold">import</emphasis> javax.security.auth.callback.CallbackHandler;
<emphasis role="bold">import</emphasis> javax.security.auth.callback.UnsupportedCallbackException;
<emphasis role="bold">import</emphasis> org.apache.ws.security.WSPasswordCallback;
 
<emphasis role="bold">public</emphasis> <emphasis role="bold">class</emphasis> KeystorePasswordCallback <emphasis role="bold">implements</emphasis> CallbackHandler
{
   <emphasis role="bold">private</emphasis> Map&lt;String, String&gt; passwords = <emphasis role="bold">new</emphasis> HashMap&lt;String, String&gt;();
 
   <emphasis role="bold">public</emphasis> KeystorePasswordCallback()
   {
      passwords.put("alice", "password");
      passwords.put("bob", "password");
   }
 
   <emphasis role="bold">public</emphasis> <emphasis role="bold">void</emphasis> handle(Callback[] callbacks) <emphasis role="bold">throws</emphasis> IOException, UnsupportedCallbackException
   {
      <emphasis role="bold">for</emphasis> (<emphasis role="bold">int</emphasis> i = 0; i &lt; callbacks.length; i++)
      {
         WSPasswordCallback pc = (WSPasswordCallback)callbacks[i];
         String pass = passwords.get(pc.getIdentifer());
         <emphasis role="bold">if</emphasis> (pass != <emphasis role="bold">null</emphasis>)
         {
            pc.setPassword(pass);
            <emphasis role="bold">return</emphasis>;
         }
      }
   }
 
   <emphasis role="bold">public</emphasis> <emphasis role="bold">void</emphasis> setAliasPassword(String alias, String password)
   {
      passwords.put(alias, password);
   }
}
</screen><para>On client side, you can similarly setup the interceptors programmatically; here is an excerpt of the client for the above described endpoint (of course you can also leverage a proper Spring configuration for loading an already configured CXF Bus instance):</para><screen xml:space="preserve">Endpoint cxfEndpoint = client.getEndpoint();
Map&lt;String,Object&gt; outProps = <emphasis role="bold">new</emphasis> HashMap&lt;String,Object&gt;();
outProps.put("action", "Timestamp Signature Encrypt");
outProps.put("user", "alice");
outProps.put("signaturePropFile", "META-INF/alice.properties");
outProps.put("signatureKeyIdentifier", "DirectReference");
outProps.put("passwordCallbackClass", "org.jboss.test.ws.jaxws.samples.wsse.KeystorePasswordCallback");
outProps.put("signatureParts", "{Element}{http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd}Timestamp;{Element}{http://schemas.xmlsoap.org/soap/envelope/}Body");
outProps.put("encryptionPropFile", "META-INF/alice.properties");
outProps.put("encryptionUser", "Bob");
outProps.put("encryptionParts", "{Element}{http://www.w3.org/2000/09/xmldsig#}Signature;{Content}{http://schemas.xmlsoap.org/soap/envelope/}Body");
outProps.put("encryptionSymAlgorithm", "http://www.w3.org/2001/04/xmlenc#tripledes-cbc");
outProps.put("encryptionKeyTransportAlgorithm", "http://www.w3.org/2001/04/xmlenc#rsa-1_5");
WSS4JOutInterceptor wssOut = <emphasis role="bold">new</emphasis> WSS4JOutInterceptor(outProps); //request
cxfEndpoint.getOutInterceptors().add(wssOut);
cxfEndpoint.getOutInterceptors().add(<emphasis role="bold">new</emphasis> SAAJOutInterceptor());
      
Map&lt;String,Object&gt; inProps= <emphasis role="bold">new</emphasis> HashMap&lt;String,Object&gt;();
inProps.put("action", "Timestamp Signature Encrypt");
inProps.put("signaturePropFile", "META-INF/alice.properties");
inProps.put("passwordCallbackClass", "org.jboss.test.ws.jaxws.samples.wsse.KeystorePasswordCallback");
inProps.put("decryptionPropFile", "META-INF/alice.properties");
WSS4JInInterceptor wssIn = <emphasis role="bold">new</emphasis> WSS4JInInterceptor(inProps); //response
cxfEndpoint.getInInterceptors().add(wssIn);
cxfEndpoint.getInInterceptors().add(<emphasis role="bold">new</emphasis> SAAJInInterceptor());
</screen><variablelist><varlistentry><term/><listitem/></varlistentry><varlistentry><term><emphasis role="bold">Package and deploy </emphasis></term><listitem/></varlistentry></variablelist><para>To deploy your web service endpoint, you need to package the following files along with your service implementation and wsdl contract:</para><itemizedlist><listitem><para> the jbossws-cxf.xml descriptor </para></listitem><listitem><para> the properties file </para></listitem><listitem><para> the keystore file (if required for signature/encryption) </para></listitem><listitem><para> the keystore password callback handler class </para></listitem></itemizedlist><para>For instance, here are the archive contents for the afore mentioned signature &amp; encryption sample (POJO endpoint):</para><screen xml:space="preserve">[alessio@localhost cxf-tests]$ jar -tvf target/test-libs/jaxws-samples-wsse-sign-encrypt.war 
   0 Tue Jun 03 19:41:26 CEST 2008 META-INF/
 106 Tue Jun 03 19:41:24 CEST 2008 META-INF/MANIFEST.MF
   0 Tue Jun 03 19:41:26 CEST 2008 WEB-INF/
   0 Tue Jun 03 19:41:26 CEST 2008 WEB-INF/classes/
   0 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/
   0 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/jboss/
   0 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/jboss/test/
   0 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/jboss/test/ws/
   0 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/jboss/test/ws/jaxws/
   0 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/
   0 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/
1628 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/KeystorePasswordCallback.class
 364 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/ServiceIface.class
 859 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/ServiceImpl.class
   0 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/jaxws/
 685 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/jaxws/SayHello.class
1049 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/org/jboss/test/ws/jaxws/samples/wsse/jaxws/SayHelloResponse.class
2847 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/jbossws-cxf.xml
   0 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/wsdl/
1575 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/wsdl/SecurityService.wsdl
 641 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/wsdl/SecurityService_schema1.xsd
1820 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/bob.jks
 311 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/classes/bob.properties
 573 Tue Jun 03 19:41:24 CEST 2008 WEB-INF/web.xml
</screen><para>On client side, instead, you only need the properties and keystore files (assuming you setup the interceptors programmatically).</para><para>Check that JBossWS-CXF is installed on your current JBoss Application Server, deploy and test your WS-Security-enabled application.</para><para> </para></section>
<section id="JBossWS-StackCXFUserGuide_WSSecurity_Policies"><title>WS-Security Policies</title><para> </para><para>Starting from JBossWS-CXF 3.1.1, WS-Security Policy implementation is available and can be used to configure WS-Security more easily.</para><para>Please refer to the <ulink url="http://cwiki.apache.org/CXF20DOC/ws-securitypolicy.html">Apache CXF documentation</ulink>; basically instead of manually configuring interceptors in the client or through jbossws-cxf.xml descriptor, you simply provide the right policies in the WSDL contract.</para><screen xml:space="preserve">  ...
  &lt;binding name="SecurityServicePortBinding" type="tns:ServiceIface"&gt;
    &lt;wsp:PolicyReference URI="#SecurityServiceSignPolicy"/&gt;
  ...
  &lt;wsp:Policy wsu:Id="SecurityServiceSignPolicy"
    xmlns:sp="<ulink url="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy">http://schemas.xmlsoap.org/ws/2005/07/securitypolicy</ulink>"&gt;
    &lt;wsp:ExactlyOne&gt;
        &lt;wsp:All&gt;
            &lt;sp:AsymmetricBinding xmlns:sp='<ulink url="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy">http://schemas.xmlsoap.org/ws/2005/07/securitypolicy</ulink>'&gt;
                &lt;wsp:Policy&gt;
                    &lt;sp:InitiatorToken&gt;
                        &lt;wsp:Policy&gt;
                            &lt;sp:X509Token sp:IncludeToken='<ulink url="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy/IncludeToken/AlwaysToRecipient">http://schemas.xmlsoap.org/ws/2005/07/securitypolicy/IncludeToken/AlwaysToRecipient</ulink>'&gt;
                                &lt;wsp:Policy&gt;
                                    &lt;sp:WssX509V3Token10 /&gt;
                                &lt;/wsp:Policy&gt;
                            &lt;/sp:X509Token&gt;
                        &lt;/wsp:Policy&gt;
                    &lt;/sp:InitiatorToken&gt;
                    &lt;sp:RecipientToken&gt;
                        &lt;wsp:Policy&gt;
                            &lt;sp:X509Token sp:IncludeToken='<ulink url="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy/IncludeToken/Always">http://schemas.xmlsoap.org/ws/2005/07/securitypolicy/IncludeToken/Always</ulink>'&gt;
                                &lt;wsp:Policy&gt;
                                    &lt;sp:WssX509V3Token10 /&gt;
                                &lt;/wsp:Policy&gt;
                            &lt;/sp:X509Token&gt;
                        &lt;/wsp:Policy&gt;
                    &lt;/sp:RecipientToken&gt;
                    &lt;sp:AlgorithmSuite&gt;
                        &lt;wsp:Policy&gt;
                            &lt;sp:Basic256 /&gt;
                        &lt;/wsp:Policy&gt;
                    &lt;/sp:AlgorithmSuite&gt;
                    &lt;sp:Layout&gt;
                        &lt;wsp:Policy&gt;
                            &lt;sp:Strict /&gt;
                        &lt;/wsp:Policy&gt;
                    &lt;/sp:Layout&gt;
                    &lt;sp:OnlySignEntireHeadersAndBody /&gt;
                &lt;/wsp:Policy&gt;
            &lt;/sp:AsymmetricBinding&gt;
            &lt;sp:Wss10 xmlns:sp='<ulink url="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy">http://schemas.xmlsoap.org/ws/2005/07/securitypolicy</ulink>'&gt;
                &lt;wsp:Policy&gt;
                    &lt;sp:MustSupportRefEmbeddedToken /&gt;
                &lt;/wsp:Policy&gt;
            &lt;/sp:Wss10&gt;
            &lt;sp:SignedParts xmlns:sp='<ulink url="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy">http://schemas.xmlsoap.org/ws/2005/07/securitypolicy</ulink>'&gt;
                &lt;sp:Body /&gt;
            &lt;/sp:SignedParts&gt;
        &lt;/wsp:All&gt;
    &lt;/wsp:ExactlyOne&gt;
  &lt;/wsp:Policy&gt;
  ...
</screen><para>Just few properties are also required to be set either in the message context or in the jbossws-cxf.xml descriptor.</para><screen xml:space="preserve">((BindingProvider)proxy).getRequestContext().put(SecurityConstants.CALLBACK_HANDLER, <emphasis role="bold">new</emphasis> KeystorePasswordCallback());
((BindingProvider)proxy).getRequestContext().put(SecurityConstants.SIGNATURE_PROPERTIES, Thread.currentThread().getContextClassLoader().getResource("META-INF/alice.properties"));
((BindingProvider)proxy).getRequestContext().put(SecurityConstants.ENCRYPT_PROPERTIES, Thread.currentThread().getContextClassLoader().getResource("META-INF/alice.properties"));
</screen><screen xml:space="preserve">&lt;beans
  xmlns='<ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>'
  xmlns:xsi='<ulink url="http://www.w3.org/2001/XMLSchema-instance">http://www.w3.org/2001/XMLSchema-instance</ulink>'
  xmlns:beans='<ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>'
  xmlns:jaxws='<ulink url="http://cxf.apache.org/jaxws">http://cxf.apache.org/jaxws</ulink>'
  xsi:schemaLocation='<ulink url="http://cxf.apache.org/core">http://cxf.apache.org/core</ulink>
    <ulink url="http://cxf.apache.org/schemas/core.xsd">http://cxf.apache.org/schemas/core.xsd</ulink>
    <ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>
    <ulink url="http://www.springframework.org/schema/beans/spring-beans-2.0.xsd">http://www.springframework.org/schema/beans/spring-beans-2.0.xsd</ulink>
    <ulink url="http://cxf.apache.org/jaxws">http://cxf.apache.org/jaxws</ulink>
    <ulink url="http://cxf.apache.org/schemas/jaxws.xsd">http://cxf.apache.org/schemas/jaxws.xsd</ulink>'&gt;
  
  &lt;jaxws:endpoint
    id='ServiceImpl'
    address='<ulink url="http://@jboss.bind.address@:8080/jaxws-samples-wssePolicy-sign">http://@jboss.bind.address@:8080/jaxws-samples-wssePolicy-sign</ulink>'
    implementor='org.jboss.test.ws.jaxws.samples.wssePolicy.ServiceImpl'&gt;
    
    &lt;jaxws:properties&gt;
       &lt;entry key="ws-security.signature.properties" value="bob.properties"/&gt;
       &lt;entry key="ws-security.encryption.properties" value="bob.properties"/&gt;
       &lt;entry key="ws-security.callback-handler" value="org.jboss.test.ws.jaxws.samples.wssePolicy.KeystorePasswordCallback"/&gt;
    &lt;/jaxws:properties&gt;
  &lt;/jaxws:endpoint&gt;
&lt;/beans&gt;
</screen><para> </para></section>
<section id="JBossWS-StackCXFUserGuide_Authentication_and_authorization"><title>Authentication and authorization</title><para> </para><para>The Username Token Profile can of course be used to provide client's credentials to the target endpoint. Starting from JBossWS-CXF 3.3.0 (which includes Apache CXF 2.2.8), the username token information can be used for authentication and authorization on JBoss AS (JAAS integration).</para><para>On server side, you need to specify what follows (for instance using a <emphasis>jbossws-cxf.xml</emphasis> descriptor):</para><itemizedlist><listitem><para>an interceptor for performing authentication and populating a valid SecurityContext; the provided interceptor should extend org.apache.cxf.ws.security.wss4j.AbstractUsernameTokenAuthenticatingInterceptor, in particular JBossWS integration comes with <emphasis>org.jboss.wsf.stack.cxf.security.authentication.SubjectCreatingInterceptor</emphasis> for this;</para></listitem><listitem><para>an interceptor for performing authorization; CXF requires that to extend org.apache.cxf.interceptor.security.AbstractAuthorizingInInterceptor, for instance the <emphasis>SimpleAuthorizingInterceptor</emphasis> can be used for simply mapping endpoint operations to allowed roles.</para></listitem></itemizedlist><screen xml:space="preserve">&lt;beans
  xmlns='<ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>'
  xmlns:xsi='<ulink url="http://www.w3.org/2001/XMLSchema-instance">http://www.w3.org/2001/XMLSchema-instance</ulink>'
  xmlns:beans='<ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>'
  xmlns:jaxws='<ulink url="http://cxf.apache.org/jaxws">http://cxf.apache.org/jaxws</ulink>'
  xmlns:util='<ulink url="http://www.springframework.org/schema/util">http://www.springframework.org/schema/util</ulink>'
  xsi:schemaLocation='<ulink url="http://cxf.apache.org/core">http://cxf.apache.org/core</ulink>
    <ulink url="http://cxf.apache.org/schemas/core.xsd">http://cxf.apache.org/schemas/core.xsd</ulink>
    <ulink url="http://www.springframework.org/schema/util">http://www.springframework.org/schema/util</ulink>
    <ulink url="http://www.springframework.org/schema/util/spring-util-2.0.xsd">http://www.springframework.org/schema/util/spring-util-2.0.xsd</ulink>
    <ulink url="http://www.springframework.org/schema/beans">http://www.springframework.org/schema/beans</ulink>
    <ulink url="http://www.springframework.org/schema/beans/spring-beans-2.0.xsd">http://www.springframework.org/schema/beans/spring-beans-2.0.xsd</ulink>
    <ulink url="http://cxf.apache.org/jaxws">http://cxf.apache.org/jaxws</ulink>
    <ulink url="http://cxf.apache.org/schemas/jaxws.xsd">http://cxf.apache.org/schemas/jaxws.xsd</ulink>'&gt;
  
  &lt;bean id="SecurityContextIn"
     class="org.jboss.wsf.stack.cxf.security.authentication.SubjectCreatingInterceptor"&gt;
    &lt;constructor-arg&gt;
      &lt;map&gt;
        &lt;entry key="action" value="UsernameToken"/&gt; 
      &lt;/map&gt;
    &lt;/constructor-arg&gt;
  &lt;/bean&gt;
 
  &lt;util:map id="methodPermissions"&gt;
     &lt;entry key="sayHello" value="friend"/&gt; 
     &lt;entry key="greetMe" value="snoopies"/&gt; 
  &lt;/util:map&gt;
 
  &lt;bean id="AuthorizeIn"
    class="org.apache.cxf.interceptor.security.SimpleAuthorizingInterceptor"&gt;
   &lt;property name="methodRolesMap" ref="methodPermissions"/&gt; 
  &lt;/bean&gt;
  
  &lt;jaxws:endpoint
    id='ServiceImpl'
    address='<ulink url="http://@jboss.bind.address@:8080/jaxws-samples-wsse-username-authorize">http://@jboss.bind.address@:8080/jaxws-samples-wsse-username-authorize</ulink>'
    implementor='org.jboss.test.ws.jaxws.samples.wsse.ServiceImpl'&gt;
    &lt;jaxws:inInterceptors&gt;
        &lt;ref bean="SecurityContextIn"/&gt;
        &lt;ref bean="AuthorizeIn"/&gt;
        &lt;bean class="org.apache.cxf.binding.soap.saaj.SAAJInInterceptor"/&gt;
    &lt;/jaxws:inInterceptors&gt;
  &lt;/jaxws:endpoint&gt;
&lt;/beans&gt;</screen><para> </para><para>Authentication and authorization will simply be delegated to the security domain configured for the endpoint. Of course you can specify the login module you prefer for that security domain (refer the application server / security documentation for that).</para><para> </para><para>On client side, the username is provided through API (or a custom Spring configuration used to load the Bus):</para><para> </para><screen xml:space="preserve">Endpoint cxfEndpoint = client.getEndpoint();
Map&lt;String, Object&gt; outProps = <emphasis role="bold">new</emphasis> HashMap&lt;String, Object&gt;();
outProps.put("action", "UsernameToken");
outProps.put("user", username);
outProps.put("passwordType", "PasswordText");
outProps.put("passwordCallbackClass", "org.jboss.test.ws.jaxws.samples.wsse.UsernamePasswordCallback");
WSS4JOutInterceptor wssOut = <emphasis role="bold">new</emphasis> WSS4JOutInterceptor(outProps); //request
cxfEndpoint.getOutInterceptors().add(wssOut);
cxfEndpoint.getOutInterceptors().add(<emphasis role="bold">new</emphasis> SAAJOutInterceptor());
</screen><para> </para><para>The password instead is provided through a password callback handler that needs to implement <emphasis>javax.security.auth.callback.CallbackHandler</emphasis>, similarly to the keystore's password callback handler.</para><para> </para><para>If you're running an older JBossWS-CXF version, or you're not interested in the the application server auth integration, you can use a password callback handler on server side too, configured through a WSS4JInInterceptor:</para><para> </para><screen xml:space="preserve">&lt;bean id="UsernameToken_Request"&gt;
  &lt;constructor-arg&gt;
    &lt;map&gt;
      &lt;entry key="action" value="UsernameToken"/&gt; 
      &lt;entry key="passwordCallbackClass" value="org.jboss.test.ws.jaxws.samples.wsse.ServerUsernamePasswordCallback"/&gt; 
    &lt;/map&gt;
  &lt;/constructor-arg&gt;
&lt;/bean&gt;
</screen><para> </para><screen xml:space="preserve"><emphasis role="bold">package</emphasis> org.jboss.test.ws.jaxws.samples.wsse;
 
<emphasis role="bold">import</emphasis> java.io.IOException;
<emphasis role="bold">import</emphasis> javax.security.auth.callback.CallbackHandler;
<emphasis role="bold">import</emphasis> javax.security.auth.callback.UnsupportedCallbackException;
<emphasis role="bold">import</emphasis> org.apache.ws.security.WSPasswordCallback;
 
<emphasis role="bold">public</emphasis> <emphasis role="bold">class</emphasis> ServerUsernamePasswordCallback <emphasis role="bold">implements</emphasis> CallbackHandler
{
   <emphasis role="bold">public</emphasis> <emphasis role="bold">void</emphasis> handle(Callback[] callbacks) <emphasis role="bold">throws</emphasis> IOException, UnsupportedCallbackException
   {
      WSPasswordCallback pc = (WSPasswordCallback)callbacks[0];
      <emphasis role="bold">if</emphasis> (!("kermit".equals(pc.getIdentifier()) &amp;&amp; "thefrog".equals(pc.getPassword())))
         <emphasis role="bold">throw</emphasis> <emphasis role="bold">new</emphasis> SecurityException("User '" + pc.getIdentifier() + "' with password '" + pc.getPassword() + "' not allowed.");
   }
}
</screen></section>
<section id="JBossWS-StackCXFUserGuide_Further_information"><title>Further information</title><variablelist><varlistentry><term><emphasis role="bold">Samples </emphasis></term><listitem/></varlistentry></variablelist><para>The JBossWS-CXF source distribution comes with some samples using X.509 certificate signature and encryption as well as Username Token Profile. You can find them in package <emphasis>org.jboss.test.ws.jaxws.samples.wsse</emphasis> .</para><variablelist><varlistentry><term><emphasis role="bold">Crypto algorithms </emphasis></term><listitem/></varlistentry></variablelist><para>When requiring encryption, you might need to install an additional JCE provider supporting the crypto algorithms Apache CXF uses. This usually means the Bouncy Castle provider need to be configured in your JRE. Please refer the <ulink url="http://community.jboss.org/docs/DOC-13532">Native stack user</ulink> guide for further information about this.</para><para> </para></section>
</section>
<section id="JBossWS-StackCXFUserGuide_JMS_transport"><title>JMS transport</title><para><link linkend="chap_JBossWS-CXFJMStransporttutorial">Here</link> is a tutorial on how to deploy and invoke a JMS endpoint using JBossWS-CXF.</para><para> </para></section>
</section>
<section id="JBossWS-StackCXFUserGuide_HTTP_server_transport_setup"><title>HTTP server transport setup</title><para>Apache CXF comes with pluggable transport layers, allowing different transport modules to be used.</para><para> </para><para>The JBossWS-CXF integration leverages CXF servlet transport for the deployment of endpoints on top of the running JBoss Application Server.</para><para> </para><para>However, when users directly leverage the JAXWS <ulink url="http://download.oracle.com/javase/6/docs/api/javax/xml/ws/Endpoint.html#publish%28java.lang.String%29">Endpoint.publish(String s)</ulink> API, endpoints are expected to be deployed on a standalone http server started just for serving the specified endpoint. Apache CXF currently defaults to using the <ulink url="http://jetty.codehaus.org/jetty/">Jetty</ulink> based http transport. Starting <emphasis>from release 3.4.0</emphasis>, the JBossWS-CXF integration instead uses a different http transport module based on the <ulink url="http://download.oracle.com/javase/6/docs/jre/api/net/httpserver/spec/com/sun/net/httpserver/package-summary.html">http server</ulink> embedded in JDK6 distributions. Thanks to Apache CXF transport pluggability, users can still change the transport they want to use in this case by simply replacing the <emphasis>jbossws-cxf-transports-httpserver.jar</emphasis> library with another http transport one, for instance the <emphasis>cxf-rt-transports-http-jetty.jar</emphasis>.</para><para> </para></section>
<section id="JBossWS-StackCXFUserGuide_SOAP_Message_Logging"><title>SOAP Message Logging</title><para>In the jbossws-cxf-client.jar[*] file you will find META-INF/cxf/cxf-extension-jbossws.xml, which contains the JBossWS extensions to the Apache CXF stack. In that file you need to enable</para><screen xml:space="preserve">  &lt;cxf:bus&gt;
    &lt;cxf:inInterceptors&gt;
      &lt;ref bean="logInbound"/&gt;
    &lt;/cxf:inInterceptors&gt;
    &lt;cxf:outInterceptors&gt;
      &lt;ref bean="logOutbound"/&gt;
    &lt;/cxf:outInterceptors&gt;
    &lt;cxf:inFaultInterceptors&gt;
      &lt;ref bean="logOutbound"/&gt;
    &lt;/cxf:inFaultInterceptors&gt;
  &lt;/cxf:bus&gt;
</screen><para> </para><para>Once you've uncommented the cxf-extension-jbossws.xml contents, you need to re-pack the jar/zip.</para><para> </para><para>[*] The cxf-extension-jbossws.xml is available from version 3.2.2; if you don't have that file, you can manually add it and link it in cxf.extensions file.</para><para> </para><para>Finally, please note that logging can be enabled in many ways with Apache CXF, see the following documentation pages for instance:</para><itemizedlist><listitem><para><ulink url="http://cxf.apache.org/docs/configuration.html">http://cxf.apache.org/docs/configuration.html</ulink></para></listitem><listitem><para><ulink url="http://cxf.apache.org/docs/debugging-and-logging.html">http://cxf.apache.org/docs/debugging-and-logging.html</ulink></para></listitem></itemizedlist></section>
</chapter>